# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

NoteSharer is a campus-specific marketplace for students at Cal Poly SLO to share high-quality study resources (notes, study guides, class overviews, Quizlet sets). The platform uses a credit-based economy where students earn credits by uploading quality content and spend credits to download others' materials. Anonymous identity (Kahoot-style random names like "PurpleElephant42") is used to protect privacy while maintaining accountability.

**Tech Stack:**
- **Frontend**: Next.js 16 (App Router), React 19, TypeScript 5
- **Backend**: Supabase (PostgreSQL database, Auth, Storage)
- **Styling**: TailwindCSS 4
- **PDF Handling**: react-pdf (pdfjs-dist 4.8.69)
- **Linting**: ESLint 9 with Next.js config

## Common Development Commands

### Development
```bash
npm run dev          # Start Next.js development server on http://localhost:3000
npm run build        # Build production bundle
npm run start        # Start production server
npm run lint         # Run ESLint
```

### Testing & Debugging
No test suite is currently configured. When adding tests, use the Next.js recommended approach with Jest or Vitest.

## High-Level Architecture

### Authentication & Session Management

**Two Supabase Client Patterns:**

1. **Client-side** (`lib/supabaseClient.ts`): Used in React components
   - Auto-refresh tokens enabled
   - Session persisted in cookies
   - Detects session from URL (for OAuth callbacks)

2. **Server-side** (`utils/supabaseServerClient.ts`): Used in API routes and Server Components
   - Reads access token from cookies (`sb-access-token`) or Authorization header
   - No session persistence or auto-refresh (stateless)
   - Creates scoped clients per request with user's JWT for RLS

**Anonymous Identity System:**
- On signup, users receive a randomly generated nickname (e.g., "PurpleElephant42", "SwiftTiger89")
- Generated by `lib/nicknames.ts` using adjectives + nouns + numbers
- Real email/identity visible only to moderators
- Nickname stored in `profiles.handle` (unique, immutable in MVP)

### API Routes Architecture

All API routes follow a consistent pattern:

1. **Extract auth token** from `Authorization: Bearer <token>` header or cookies
2. **Create server-side Supabase client** using `createClient(bearerToken)`
3. **Verify user** via `supabase.auth.getUser()`
4. **Execute business logic** with user-scoped client (respects RLS policies)
5. **Return JSON response**

**Key API Routes:**
- `/api/upload` (POST): PDF upload to Supabase Storage, creates resource record
  - Max 25MB PDF files
  - Validates class_id (UUID), title (required)
  - Supports bypass mode for testing (env: `NEXT_PUBLIC_UPLOAD_BYPASS=true`)
  - Stores in `resources` bucket with path: `{userId}/{uuid}-{filename}.pdf`
- `/api/notes` (GET): Paginated resource listing with vote stats
  - Query params: `page`, `page_size`, `class_id`, `sort` (newest/oldest)
  - Joins with `profiles` for display names
  - Joins with `resource_vote_stats` view for upvote/downvote counts
  - Returns signed URLs for preview images (1 hour expiry)
- `/api/classes` (GET): List all courses from `courses` table
  - Returns id, name (title), and code (department + course_number)

### Database Schema (Key Tables)

See `supabase/migrations/202411100910_note_sharer_base_schema.sql` for full schema.

**Core Tables:**
- `profiles`: User profiles with `handle` (nickname), `display_name`, `campus_email`
- `user_roles`: Role assignments (student, moderator, teacher, ta, admin, developer)
- `courses`: Course catalog (department, course_number, title, term, year)
- `resources`: Uploaded files/links with status (pending, active, flagged, removed, archived)
  - Fields: `profile_id`, `course_id`, `title`, `file_key`, `preview_key`, `download_cost` (default 3 credits)
  - Indexed on: course_id, profile_id, tags (gin), full-text search (gin)
- `votes`: Upvotes/downvotes on resources (value: 1 or -1)
- `credits_ledger`: Transaction log for credit system (source: upload_reward, upvote_bonus, download)
- `download_vouchers`: Free download vouchers (e.g., signup bonus)
- `resource_downloads`: Download history with credits spent or voucher used
- `reports`: User-reported content (categories: ip, cheating, abuse, spam, other)
- `moderation_actions`: Moderator action log

**Important Views:**
- `credit_balances`: Aggregates credits per profile from ledger
- `resource_vote_stats`: Aggregates upvotes, downvotes, and score per resource

**RLS (Row-Level Security):**
All tables have RLS enabled. Policies are defined in base schema migration. Key patterns:
- Most tables readable by authenticated users
- Users manage their own records (profiles, votes, uploads)
- Moderators have elevated read access (reports, course submissions)
- Credits/vouchers visible only to owner

### Credit Economy

**Earn Credits:**
- Upload reward: +5 credits upon approval (via `rpc_award_upload_credits`)
- Upvote bonus: +1 credit per upvote (up to 10 upvotes per resource, see `fn_handle_vote_credits` trigger)

**Spend Credits:**
- Download cost: 3 credits (configurable per resource via `download_cost` field)
- Downloads consume vouchers first, then deduct credits (via `rpc_consume_download`)

**Signup Bonus:**
- New users receive 2 free download vouchers (non-transferable, stored in `download_vouchers`)

### PDF Handling

**react-pdf Configuration:**
- Worker loaded from CDN: `pdfjs-dist@4.8.69` (see `app/components/pdf/pdfConfig.ts`)
- Component: `PDFThumbnail` renders first page as thumbnail (200px width)

**Storage:**
- Bucket: `resources` (private, not public)
- Access via signed URLs (short TTL, typically 1 hour)
- File paths: `{userId}/{uuid}-{sanitized-filename}.pdf`

### Frontend Patterns

**App Router Structure:**
- `/` - Landing page (marketing, public)
- `/auth` - Authentication page
- `/auth/callback` - OAuth callback handler
- `/dashboard` - Main dashboard (class filter, note listing, pagination)
- `/test-upload` - Test upload page (dev/testing only)

**State Management:**
- Uses React hooks (`useState`, `useEffect`)
- No global state library (Redux, Zustand, etc.) currently
- Auth state managed by Supabase client

**Data Fetching:**
- Client-side fetching via `fetch()` API
- Auth token passed via `Authorization: Bearer` header
- Pagination handled with `page`, `page_size` query params

## Environment Variables

Required environment variables (set in `.env.local` or deployment environment):

```bash
# Supabase
NEXT_PUBLIC_SUPABASE_URL=         # Supabase project URL
NEXT_PUBLIC_SUPABASE_ANON_KEY=    # Supabase anon/public key
SUPABASE_SERVICE_ROLE_KEY=        # Supabase service role key (server-only, admin privileges)

# Upload bypass (optional, for testing without auth)
NEXT_PUBLIC_UPLOAD_BYPASS=false   # Set to "true" to enable bypass
UPLOAD_BYPASS_PROFILE_ID=         # Profile ID to use when bypassing auth
```

**Security Notes:**
- Never commit `.env.local` or expose `SUPABASE_SERVICE_ROLE_KEY` in client-side code
- Service role key is used only in API routes for admin operations (file upload, signed URLs)

## Code Organization Conventions

**Path Aliases:**
- `@/*` maps to project root (configured in `tsconfig.json`)
- Example: `import { supabase } from "@/lib/supabaseClient"`

**File Naming:**
- React components: PascalCase (e.g., `PDFThumbnail.tsx`)
- Utilities: camelCase (e.g., `supabaseClient.ts`, `nicknames.ts`)
- API routes: `route.ts` (Next.js convention)

**TypeScript:**
- Strict mode enabled (`strict: true`)
- Target: ES2017
- Module resolution: bundler

## Working with Supabase

**Database Migrations:**
- Located in `../supabase/migrations/` (one level up from frontend)
- Applied in order by timestamp prefix
- To create new migration: Create SQL file with format `YYYYMMDDHHMM_description.sql`

**Storage Buckets:**
- `resources`: PDF uploads (private, 25MB limit, application/pdf only)
- Bucket auto-created by `/api/upload` if missing

**RPC Functions:**
- `rpc_award_upload_credits(p_resource_id uuid)`: Award +5 credits for upload (idempotent)
- `rpc_consume_download(p_resource_id uuid, p_profile_id uuid)`: Handle download with voucher/credit deduction

## Key Dependencies

- `@supabase/supabase-js@^2.83.0`: Supabase client library
- `next@16.0.3`: React framework
- `react@19.2.0`, `react-dom@19.2.0`: React library
- `react-pdf@9.1.0`, `pdfjs-dist@4.8.69`: PDF rendering
- `tailwindcss@^4`: Utility-first CSS framework

## Notes for Future Development

**Moderation System (PRD mentions, not fully implemented yet):**
- Resources have `status` field: pending â†’ active (after approval) or rejected
- Moderators review uploads via moderation queue
- AI pre-screening planned: keyword detection, duplicate detection (pHash), OCR quality checks

**Features in PRD but may not be fully implemented:**
- Voting system (tables exist, but UI may be minimal)
- Comments (not in schema yet, deferred to post-MVP)
- Advanced search, filters, recommendations (deferred to post-MVP)
- Course submission flow for user-requested courses (table exists, UI may be minimal)
- Rating system (schema prepared, deferred to post-MVP)

**When adding new features:**
- Follow existing API route patterns (auth extraction, RLS-scoped clients)
- Add database migrations to `../supabase/migrations/`
- Respect credit economy rules (costs, rewards, vouchers)
- Maintain anonymous identity (never expose real email in client-facing APIs)
